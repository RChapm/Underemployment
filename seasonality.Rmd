---
title: "Seasonality"
author: "David Su"
output:
  html_document:
    df_print: paged
---
Libraries used in this project:
```{r setup}
suppressPackageStartupMessages(library(forecast)) # silently adds library
library(stats)
rm(list=ls()) # removes previous variables
```

<!-- click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file. -->

Import the data
```{r import_csv}
csv<-read.csv('rawdata.csv', header = TRUE)
names(csv)=c('date','unemp')
head(csv)
```

Select data starting from the last NBER recession, i.e. December 2017.
```{r}
head(csv[-(1:167),])
```
Construct the time series object and plot it
```{r}
UnEmp=ts(csv$unemp[-(1:167)],start=c(2007,12),freq=12)
plot(UnEmp)
```

# 2. Modeling and Forecasting Seasonality
**(a) Construct and test (by looking at the diagnostic statistics) a model with a full set of seasonal dummies.**

Construct the seasonal model `seas` and print out a summary. The model formula is $$UNEMP_t=\beta_1+\beta_2FEB_t+\beta_3MAR_t+...+\beta_{12}DEC_t+\varepsilon_t$$
where $FEB_t$, $MAR_t$,..., $DEC_t$ are indicator variables for the months less January.
```{r}
seas=tslm(UnEmp~season) # linear regress on seasonal indicators
(s_seas=summary(seas)) # regression summary
```
None of the seasonal coefficients are significant at 5% level. The statistics $R^2$ and $R^2_{\mathrm{adj}}$  are close to 0, and the $p$-value for the $F$-statistic is very high, all seems to suggest that this is a fairly bad model.

Here we plot the seasonal coefficients. The reference is set at the average of the months.
```{r}
seas_factors=seas$coef # copy the regression coefs over
seas_factors[1]=0 # zero the value of the intercept
names(seas_factors)[1]='season1' # rename (Intercept) to season1
seas_factor=seas_factors-mean(seas_factors)

plot(seas_factors, type='l', lwd=2,
     xlab="Month", ylab='Seasonal Factors',
     main="Plot of Seasonal Factors")

```

Plot the residuals
```{r}
hist(seas$res,main='Histogram of Residuals',col='grey')
plot(seas$res)

```





# Fiddle 1
Take the first difference
```{r}
d_UnEmp=UnEmp-lag(UnEmp,-1)
plot(d_UnEmp,
     xlab='Year',
     ylab='Change in Unemployment, p.p.',
     main='Monthly Changes in Unemployment')
```

# regress out the seasonal factors
```{r}
seas_d_UnEmp=tslm(d_UnEmp~season)
s_seas_d_UnEmp=summary(seas_d_UnEmp)
plot(d_UnEmp)
lines(seas_d_UnEmp$fitted.values,col='red')
plot(s_seas_d_UnEmp$residuals)
```

acf and pacf of the residuals
```{r}
acf(s_seas_d_UnEmp$res)
pacf(s_seas_d_UnEmp$res)
```

# Fiddle 2
```{r}
dd_UnEmp=d_UnEmp-lag(d_UnEmp,-1)
plot(dd_UnEmp,main = "Second difference in unemployment")
```
This is useless because the noise got amplified by taking the difference

# Fiddle 3
```{r non-linear}
adj_t=time(UnEmp)-2008
nltrend=nls(UnEmp~a*exp(-k*adj_t)+b*adj_t+c*adj_t**2+f,
    start=c(a=-10,k=1,b=-1,c=0,f=20))
s_nltrend=summary(nltrend)
print(s_nltrend)
# residual plot
plot(s_nltrend$res,type='l')

trend_res=ts(s_nltrend$res,start=c(2007,12),freq=12)
trend_fitted=UnEmp-trend_res

plot(UnEmp)
lines(trend_fitted,col='red')

# seasonal model on the residuals of trend
seas_on_res=tslm(trend_res~season)
s_seas_on_res=summary(seas_on_res)
print(s_seas_on_res)

# residuals of seasonal model
plot(s_seas_on_res$res)


plot(UnEmp)
lines(trend_fitted+seas_on_res$fitted.values,col='red')
```

